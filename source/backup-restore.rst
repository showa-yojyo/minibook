======================================================================
バックアップ＆復旧ノート
======================================================================

本ノートは私の Windows PC 環境を復旧・復元可能な水準でバックアップする手順を述べ
るものだ。

.. contents::

目的と目標
======================================================================

OS は Windows 10 だが、OS をアップグレードしても旧環境の良さを持ち越したいので、
後述の手順すべてにおいてそれを念頭に置きたい。

再びホームレスになっても対応し易いようにノート PC であることを想定する。

バックアップと復旧の目標は盗難にあっても新 PC でなじみの環境を復旧できることだ。

バックアップ原則
======================================================================

* 手順を自動化しておくのが望ましい。
* 専門家のオンラインサービスを利用することを優先する。次の条件が望ましい：

  * 利用期間が設けられていない（一定期間後、サービスが対象ファイルを削除しない）
  * サービス側が対象ファイルの内容を検閲しない

* インターネットからダウンロード可能なファイルや、公開データから復元可能なファイ
  ルについては、成果物そのものをバックアップしないで URL を記録しておく。
* 機密情報は生データをバックアップしない。最低限パスワード付き圧縮ファイルに変換
  してバックアップする。
* テキストファイルは許す限り GitHub にリポジトリーを用意する。ただし Private
  モードに頼らない。
* ファイル以外の形式で保存される情報のバックアップを漏らさない。

全体バックアップ＆復元
======================================================================

この節の内容が毎回実現可能であれば、以降の節は実施しなくていい。

.. todo::

   以前実施した HDD を OS ごと SSD に複製、PC に換装したときの手順を記す。

部分的バックアップ＆復元
======================================================================

急所のデータ（主にファイル）だけをバックアップできれば十分という場合もある。全体
バックアップとは別に、個別にバックアップ可能であるものは追加的にそうしておきた
い。まずバックアップ対象を自分の中で確定してしまう。

* ソフトウェアおよびその設定
* ユーザーファイル (``%USERPROFILE%``)
* ブックマーク
* メール
* レジストリー
* 環境変数
* 機密データ
* WSL

ソフトウェアおよびその設定
----------------------------------------------------------------------

これはソフトウェア本体と設定を分けて考える必要がある。

Windows 標準のインストーラーを使ってインストールしたソフトに関しては、インストー
ラー配布場所を控えておいて、後でインストーラーを入手し、それを用いて復元可能だ。
とりわけ、:program:`winget` で管理しているものについては自動処理も視野に入れた操
作が容易だ。いつでも最新版の実行形式をインストールしたい場合にはこれでいい。

インターネット上ではすでに配布されていない版のソフトウェアが必要である場合、イン
ストーラーを適当な USB 棒にたいせつに保存しておく。もっとも、そういうソフトは利
用しないで済むのが望ましい。

.. seealso::

   :doc:`/winget`

設定はソフトウェアごとに保存方式が異なるので、バックアップ方法も異なる。場合分け
して実施する。

* :file:`%APPDATA%` など、設定ファイル用フォルダーのサブフォルダーにあるファイル
* レジストリーのソフトウェア固有のエントリー
* それ以外

:file:`%APPDATA%` からバックアップ対象のソフトウェアに関するフォルダーごとバック
アップストレージに保管する。フォルダーを上書きして復元する。

なお、:file:`%APPDATA%` 以外にも、次のフォルダーも気をつける：

* :file:`%HOME%`
* :file:`%HOME\\.config%`

レジストリーに設定を書き出すソフトウェアに関しては、レジストリーをエクスポートし
て ``reg`` ファイルをバックアップストレージに保管する。エクスポートのときに、ソ
フトウェアエントリー単位で行うと、ソフトウェアごとに復元することができて柔軟だ。

それ以外について、例えばインストールフォルダーの内部に設定ファイルを保存するよう
なものについてはバックアップは厄介だ。ファイルを個別にバックアップせねばならな
い。管理が煩雑だし、復元時も面倒だ。

ユーザーファイル
----------------------------------------------------------------------

基本的に、自作の書類、帳簿、ビデオなどはフォルダー :file:`%USERPROFILE%` の対応
するサブフォルダーに作成する習慣とする。これらのサブフォルダーについては、丸ごと
バックアップストレージにコピーして保管するのが理想的だ：

* :file:`%USERPROFILE%\\Desktop`
* :file:`%USERPROFILE%\\Documents`
* :file:`%USERPROFILE%\\Downloads`
* :file:`%USERPROFILE%\\Favorites`
* :file:`%USERPROFILE%\\Music`
* :file:`%USERPROFILE%\\Pictures`
* :file:`%USERPROFILE%\\Videos`

なお、そもそもデスクトップにファイルを配置しないほうがいい。それ以外のサブフォル
ダーに移す。

ファイルサイズが大きいはずなので、一部はバックアップ不能というのが普通だ。そうい
う場合は後述の（無料）ストレージサービスを利用するなどして分散保管する。それ以外
はフォルダーごとバックアップ先に保管する。

Windows PC を新規調達した場合には、これらのサブフォルダーを新環境の
:file:`%USERPROFILE%` にマージ上書きする。これで復元したことになる。

ブックマーク
----------------------------------------------------------------------

私は Windows 既定のブラウザーをいっさい利用していないので、上述の
:file:`%USERPROFILE%\\Favorites` バックアップでは不十分だ。Sleipnir のバックアッ
プで代える。

以下、Sleipnir のブックマークと RSS の簡易バックアップ方法を記す。ブックマークに
ついては次の手順で出力される HTML ファイルを適宜保管する：

1. :guilabel:`Sleipnir --> ブックマークのエクスポート (&E) ...` を選択
2. 保存先フォルダーをツリー上で選択して :guilabel:`OK` を押す

.. todo::

   復元手順が特殊なのでよく調べてから記す。いったん Internet Explorer か
   Microsoft Edge を経由する方法があると記憶している。

ブックマークの他に RSS リーダーもバックアップする。

1. :guilabel:`Sleipnir --> 表示 (&V) --> FeedReader を表示` を選択して表示状態に
   する
2. :guilabel:`すべてのアイテム` を選択状態にする
3. 歯車メニューから :guilabel:`インポートおよびエクスポート --> OPML 形式でエク
   スポート (&I)...` を選択
4. 保存先ファイルを決定して :guilabel:`保存 (&S)` を押す

保存先の既定パスが変なところにあるので注意すること。必ずバックアップ先に変えろ。
復元手順は上記手順のエクスポートの代わりにインポートを指示すれば後は自明だ。

メール
----------------------------------------------------------------------

メールは Hotmail 現 Outlook.com, Gmail など、外部サーバーに保管してあるから余計
なことをしなければバックアップを考えないほうがいい。自分でバックアップするより保
管成功率がはるかに高い。

Thunderbird などのメールクライアント環境（設定）のバックアップと復元するには、上
述のソフトウェア一般に関する節で述べた方法を採用する。

Windows レジストリー
----------------------------------------------------------------------

レジストリーは基本的に一枚岩のファイルなので、全体バックアップでいいと思う。その
部分を後から抽出することは専用エディターで可能であるはず。試しにレジストリー全体
をエクスポートしたら 300MB を超える ``reg`` ファイルが生じた。

本番時に次の記事を参照すればいいだろう：

* `How to back up and restore the registry in Windows - Microsoft Support
  <https://support.microsoft.com/en-au/topic/how-to-back-up-and-restore-the-registry-in-windows-855140ad-e318-2a13-2829-d428a2ab0692>`__
* `特定のレジストリ・キー以下を素早くバックアップする － ＠IT
  <https://atmarkit.itmedia.co.jp/fwin2k/win2ktips/593regsave/regsave.html>`__

.. admonition:: 利用者ノート

   :kbd:`CapsLock` と左 :kbd:`Ctrl` を入れ替えるためにレジストリーを使っていて、
   そのバックアップと復元が気になているような場合、レジストリー操作手順が Google
   検索ですぐに見つかるので、バッアップしないで済む。

機密データ
----------------------------------------------------------------------

機密情報・データには次のものがある：

* 求人応募資料群（履歴書、職務経歴書、証明写真、応募履歴台帳）
* 報告書、家計簿、納税ファイル
* パスワード台帳、SSH 秘密鍵を含むテキストファイル、設定ファイルの機密情報部分

次のいずれかの形式で保管すること：

* パスワード付きスプレッドシート (Excel, LibreOffice, etc.)
* パスワード付き ZIP ファイル

これは通常時でもパスワードを付けて管理するのが安全保障上望ましい。解凍パスワード
は脳裡にのみ収めること。

暗号化ファイルの保管先はオンラインストレージが実はいい。自分で所有している USB
棒やドライブでは足りない。ホームレスのときにノート PC ごと盗難に遭った時にそれで
しのいだ実績がある。

WSL
----------------------------------------------------------------------

WSL 環境を丸ごとバックアップする方法は、それを含む Windows 環境を丸ごとバック
アップする方法を除けば次の記事のようにする：

`How to back up and restore a Windows Subsystem for Linux (WSL) distro
<https://www.xda-developers.com/how-back-up-restore-wsl/>`__

注意点が二つある：

* 作業前に WSL を完全に停止すること。コマンド ``wsl --terminate`` が良い。
* ``wsl --export`` するまでは登録解除系のコマンドを決して実行するな。WSL イメー
  ジが消滅する。
* ``wsl --import`` すると、おそらく Ubuntu コンソールを起動したときにユーザーを
  「忘れている」状態でプロンプトが示される。その場合にはファイル
  :file:`/etc/wsl.conf` を root 編集して、既定ユーザーを示すこと：

  .. code:: ini

     [user]
     default={{ YOUR_USER_NAME }}

利用ツール
======================================================================

バックアップおよび復元の際に用いるツールおよび手順を述べる。

オンラインストレージ
----------------------------------------------------------------------

次のサービスをバックアップするファイルの性質によって使い分ける。無料プランでも
けっこうな容量を使わせてくれる。

`Dropbox <https://www.dropbox.com/>`__
   無料プランで 2GB 利用可。比較的ファイル容量の小さい個人情報ファイルを暗号化か
   つ圧縮して保管している。対象ファイルはローカルとリモートの両方に存在する方式
   だ。個人的には PC を盗まれた後にファイルを失わずに済んだ実績がある。盗難 PCか
   のアクセスを奪うことも可能だが、PC 本体内のストレージに同じファイルがあるの
   で、やはりパスワードを付けるのが肝要だ。

   Web ブラウザーからもファイルにアクセス可能。しかし、普通は Dropbox サービスを
   稼働させておき、Windows Explorer でファイル操作する運用だ。
`Google Drive <https://www.google.com/drive/>`__
   私は未使用。Gmail などのサービスと利用可能容量が統合されていて、関係サービス
   全体で消費可能な容量の和の上限が 15GB ということだ。

   長期間（二年？）放置で、保管ファイルが削除されるという規約があるようだ。これ
   を逆用したい場合に利用しよう。
`Microsoft OneDrive <https://www.microsoft.com/ja-jp/microsoft-365/onedrive/online-cloud-storage>`__
   私は未使用。:file:`%USERPROFILE%\\OneDrive` フォルダーは空にしている。Google
   Drive と似たような制約がある。
`pCloud <https://www.pcloud.com/>`__
   無料プランでは pCloud の要望に応えられれば高々 10GB 利用可。自分で収録、編集
   した音声・映像ファイルで当面出番がないものを保管する用途に充てている。

   Windows のドライブレターを一つ消費する形でストレージが生じる。対象ファイルは
   接続が有効な間のみアクセス可能であり、ローカルには残らない。接続がしょっちゅ
   う切断されるようで、パスワードを毎回入力して再接続するのが面倒だ。

.. admonition:: 利用者ノート

   オンラインストレージについては調査研究が足りていない。自力でバックアップスト
   レージを確保できないほど貧窮したら必要になるサービスであるのだが。

SNS
----------------------------------------------------------------------

プラットフォームそれぞれにおいて、特定の条件に従う限りファイル容量が事実上無制限
であることを利用することが考えられる。

`GitHub <https://github.com/>`__
   Git リポジトリーを設置するためのサービスだが、テキストファイルのバックアップ
   場所として捉えることも利用可能だ。仲間がいれば、リポジトリーをクローンしても
   らうと安心が増すことだろう。

   対象としては日記、備忘録、報告書、原稿置場として最適。一方で、特に容量が大き
   い画像、音声、映像ファイルはバックアップ用途には不向きだ。

   設定ファイル（ドットファイル）を集約したリポジトリーを設けるのは良い習慣だ。
   環境に対応するブランチを定義して管理するといい。
`Facebook <https://www.facebook.com/>`__
   私は未使用。バックアップストレージとして利用可能なのかどうかも承知していない
   が、後述の Twitter と同様の見方で保管先として運用することが可能なのではと考え
   ている。
`Twitter <https://twitter.com/>`__
   かなりの制約があるが、画像や映像ファイルを投稿しておくことでバックアップとす
   る場合がある。消失する可能性がないと断言できればもっと良い用途をひねり出す。
`YouTube <https://www.youtube.com/>`__
   私は未使用。自分が収録、編集した音声および映像ファイルのバックアップストレー
   ジとして応用することが考えられる。

ハードウェア
----------------------------------------------------------------------

USB 棒、携帯電話、外付け SSD などを所有していれば利用する。

USB 棒は一時的なバックアップ先という役目で使用している。用事が済んだらバックアッ
プのほうを消去。コンパクトさゆえに丸ごと紛失しやすいので、さらに守備的な運用にな
る。

本当に重要なファイルに限り、オンラインストレージに加え携帯電話内のストレージにも
複製を保存しておく。携帯電話にインストールされているオンラインストレージとの連携
アプリがクラウドに結局バックアップするから冗長であるという気がしないでもない。

外付け SSD については先述のとおり。新調するときにはジャンクショップではなく、量
販店で買い求めろ。遊び目的ではないのだ。
